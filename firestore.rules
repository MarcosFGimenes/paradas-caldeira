rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function hasValidString(field, max) {
      return !(field in request.resource.data) ||
        (request.resource.data[field] is string &&
          request.resource.data[field].size() > 0 &&
          request.resource.data[field].size() <= max);
    }

    function hasValidStatus() {
      return !("status" in request.resource.data) ||
        request.resource.data.status in [
          "planning",
          "in_progress",
          "completed",
          "paused"
        ];
    }

    function hasMatchingCreator() {
      return !("createdBy" in request.resource.data) ||
        request.resource.data.createdBy == request.auth.uid;
    }

    // Leituras são públicas para permitir o compartilhamento de links sem exigir autenticação.
    match /packages/{id} {
      allow read: if true;
      allow create, update, delete: if isSignedIn() &&
        hasValidString("name", 200) &&
        hasValidString("description", 2000) &&
        hasValidStatus() &&
        hasMatchingCreator();
    }

    match /subpackages/{id} {
      allow read: if true;
      allow create, update, delete: if isSignedIn() &&
        hasValidString("packageId", 128) &&
        hasValidString("name", 200) &&
        hasValidString("description", 2000);
    }

    match /workorders/{id} {
      allow read: if true;
      allow create, update, delete: if isSignedIn() &&
        hasValidString("packageId", 128) &&
        hasValidString("subPackageId", 128) &&
        hasValidString("title", 500) &&
        hasValidString("status", 50);
    }

    match /workorderlogs/{id} {
      allow read: if true;
      allow create: if isSignedIn() &&
        hasValidString("workOrderId", 128) &&
        hasValidString("message", 2000);
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
